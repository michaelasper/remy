<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Remy Control Center</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eef2ff",
                100: "#e0e7ff",
                200: "#c7d2fe",
                300: "#a5b4fc",
                400: "#818cf8",
                500: "#6366f1",
                600: "#4f46e5",
                700: "#4338ca",
                800: "#3730a3",
                900: "#312e81",
              },
            },
          },
        },
      };
    </script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  </head>
  <body class="min-h-screen bg-slate-950 text-slate-100 selection:bg-primary-500/40">
    <script type="application/json" id="sample-context">__SAMPLE_CONTEXT__</script>
    <div id="app" class="min-h-screen flex flex-col">
      <header
        class="bg-slate-900/70 border-b border-slate-800 backdrop-blur-lg sticky top-0 z-30"
      >
        <div class="max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-4 flex flex-col gap-4">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h1 class="text-2xl font-semibold text-white">Remy Control Center</h1>
              <p class="text-sm text-slate-300">
                Your tiny rat chef tracks planning context, pantry inventory, preferences, and receipts from one kitchen console.
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button
                @click="promptToken"
                class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
              >
                <span class="i-lucide-key"></span>
                <span>{{ token ? "Update API Token" : "Set API Token" }}</span>
              </button>
              <button
                @click="refreshAll"
                class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
              >
                <span class="i-lucide-refresh-cw"></span>
                <span>Refresh Data</span>
              </button>
            </div>
          </div>
          <nav class="flex flex-wrap gap-2 overflow-x-auto hide-scrollbar">
            <button
              v-for="tab in tabs"
              :key="tab.id"
              @click="setTab(tab.id)"
              class="flex items-center gap-2 rounded-lg px-4 py-2 text-sm font-medium transition"
              :class="currentTab === tab.id
                ? 'bg-primary-600 text-white shadow-lg shadow-primary-900/40'
                : 'bg-slate-800/70 text-slate-200 hover:bg-slate-700'"
            >
              <span class="text-base">{{ tab.icon }}</span>
              <span>{{ tab.label }}</span>
            </button>
          </nav>
        </div>
      </header>

      <main class="flex-1 w-full">
        <div class="max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6">
          <!-- Planner -->
          <section
            v-if="currentTab === 'planner'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-2">
              <div class="flex flex-col gap-4">
                <header class="space-y-2">
                  <h2 class="text-xl font-semibold text-white">Planner Inputs</h2>
                  <p class="text-sm text-slate-300">
                    Set tonight‚Äôs scene and Remy (yes, the rat) will pull preferences and pantry intel automatically.
                  </p>
                </header>
                <form @submit.prevent="generatePlan" class="grid gap-4">
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Dinner Date</label>
                    <input
                      v-model="planner.form.date"
                      type="date"
                      required
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                    />
                  </div>
                  <div class="grid gap-4 sm:grid-cols-2">
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Attendees</label>
                      <input
                        v-model.number="planner.form.attendees"
                        type="number"
                        min="1"
                        step="1"
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        placeholder="2"
                      />
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Time Window</label>
                      <select
                        v-model="planner.form.time_window"
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      >
                        <option value="">Flexible</option>
                        <option value="evening">Evening</option>
                        <option value="afternoon">Afternoon</option>
                        <option value="lunch">Lunch</option>
                      </select>
                    </div>
                  </div>
                  <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 space-y-4">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                      <div>
                        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Preference Overrides</h3>
                        <p class="text-xs text-slate-500">
                          Apply diet, allergen, or cuisine tweaks for this run without changing saved preferences.
                        </p>
                      </div>
                      <button
                        type="button"
                        @click="applySavedPreferenceOverrides"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-1.5 text-xs font-semibold text-slate-100 transition hover:bg-slate-800"
                      >
                        <span class="i-lucide-refresh-cw text-sm"></span>
                        <span>Use saved prefs</span>
                      </button>
                    </div>
                    <div class="grid gap-4 md:grid-cols-2">
                      <div class="flex flex-col gap-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Diet</label>
                        <select
                          v-model="planner.form.diet_override"
                          class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        >
                          <option value="">Use saved preference</option>
                          <option v-for="option in dietOptions" :key="option.value" :value="option.value">
                            {{ option.label }}
                          </option>
                        </select>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Max Prep Time (min)</label>
                        <input
                          v-model="planner.form.max_time_min"
                          type="number"
                          min="0"
                          step="5"
                          placeholder="30"
                          class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        />
                        <p class="text-xs text-slate-500">Leave blank to reuse saved max.</p>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Allergens (comma separated)</label>
                        <input
                          v-model="planner.form.allergens_text"
                          type="text"
                          placeholder="peanut, soy"
                          class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        />
                        <p class="text-xs text-slate-500">Only overridden items will be enforced.</p>
                      </div>
                      <div class="flex flex-col gap-2">
                        <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Preferred Cuisines</label>
                        <input
                          v-model="planner.form.cuisines_text"
                          type="text"
                          placeholder="mexican, mediterranean"
                          class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        />
                        <p class="text-xs text-slate-500">Comma-separated list used as soft guidance.</p>
                      </div>
                    </div>
                  </div>
                  <div class="rounded-xl border border-slate-800 bg-slate-950/40 p-4 space-y-3">
                    <div class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
                      <div>
                        <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Recipe Search</h3>
                        <p class="text-xs text-slate-500">
                          Pull fresh recipe inspiration via DuckDuckGo; enter optional keywords to steer the search.
                        </p>
                      </div>
                      <label class="inline-flex items-center gap-2 text-xs font-semibold text-slate-200">
                        <input
                          type="checkbox"
                          v-model="planner.form.search_enabled"
                          class="h-4 w-4 rounded border-slate-600 bg-slate-900 text-primary-500 focus:ring-primary-500"
                        />
                        <span>{{ planner.form.search_enabled ? "Search enabled" : "Search disabled" }}</span>
                      </label>
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-400">Keyword Filters</label>
                      <input
                        v-model="planner.form.search_keywords_text"
                        type="text"
                        :disabled="!planner.form.search_enabled"
                        placeholder="e.g., sheet pan dinner, smoky, citrus"
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40 disabled:cursor-not-allowed disabled:opacity-60"
                      />
                      <p class="text-xs text-slate-500">Comma-separated; leave blank to search based on pantry items.</p>
                    </div>
                  </div>
                  <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm" :class="planner.contextStatusColor">{{ planner.contextStatus }}</p>
                    <div class="flex flex-wrap gap-2">
                      <button
                        type="button"
                        @click="assemblePlanningContext()"
                        :disabled="planner.contextLoading"
                        class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-700 bg-slate-900 px-4 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800 disabled:cursor-not-allowed disabled:opacity-70"
                      >
                        <span class="i-lucide-database"></span>
                        <span>{{ planner.contextLoading ? "Assembling‚Ä¶" : "Assemble Context" }}</span>
                      </button>
                      <button
                        type="submit"
                        :disabled="planner.loading"
                        class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                      >
                        <span class="i-lucide-wand-2"></span>
                        <span>{{ planner.loading ? "Generating‚Ä¶" : "Generate Plan" }}</span>
                      </button>
                    </div>
                  </div>
                </form>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-400">Context Preview</h4>
                      <p class="text-xs text-slate-500">Read-only snapshot assembled from the database.</p>
                    </div>
                    <span class="rounded-full bg-slate-800 px-3 py-1 text-xs font-semibold text-slate-200">
                      {{ planner.contextObject?.inventory?.length || 0 }} inventory items
                    </span>
                  </div>
                  <div class="min-h-[200px] rounded-xl border border-slate-800 bg-slate-950/70 p-4 font-mono text-xs leading-6 text-slate-100 shadow-inner overflow-auto">
                    <pre class="whitespace-pre-wrap break-words">{{ formattedContext }}</pre>
                  </div>
                </div>
              </div>
              <div class="flex flex-col gap-4">
                <header class="flex flex-col gap-3">
                  <div>
                    <h3 class="text-xl font-semibold text-white">Recipe Showcase</h3>
                    <p class="text-sm text-slate-300">
                      Remy renders the latest plan as cozy, human-friendly recipes.
                    </p>
                    <p class="text-xs text-slate-400">
                      Plan date: <span class="font-semibold text-slate-200">{{ planDateLabel }}</span>
                    </p>
                  </div>
                  <div class="flex flex-wrap items-center gap-3">
                    <div class="inline-flex items-center gap-2 rounded-2xl border border-slate-700 bg-slate-900/60 px-3 py-2 text-sm text-slate-200 shadow-inner">
                      <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">Target Servings</span>
                      <div class="flex items-center gap-1">
                        <button
                          class="rounded-full border border-slate-700 bg-slate-800 px-2 py-1 text-lg leading-none text-slate-100 hover:bg-slate-700"
                          @click="adjustServings(-0.5)"
                          type="button"
                        >
                          &minus;
                        </button>
                        <span class="min-w-[60px] text-center font-semibold text-white">
                          {{ servingBadge }}
                        </span>
                        <button
                          class="rounded-full border border-slate-700 bg-slate-800 px-2 py-1 text-lg leading-none text-slate-100 hover:bg-slate-700"
                          @click="adjustServings(0.5)"
                          type="button"
                        >
                          +
                        </button>
                      </div>
                    </div>
                    <button
                      type="button"
                      @click="planner.showRaw = !planner.showRaw"
                      :class="planner.showRaw ? 'bg-primary-600 text-white' : 'bg-slate-800 text-slate-200 hover:bg-slate-700'"
                      class="inline-flex items-center gap-2 rounded-xl border border-slate-700 px-4 py-2 text-sm font-medium transition"
                    >
                      <span class="i-lucide-code"></span>
                      <span>{{ planner.showRaw ? "Hide JSON" : "View JSON" }}</span>
                    </button>
                  </div>
                  <p class="text-xs" :class="planner.statusColor">{{ planner.status }}</p>
                </header>

                <div
                  v-if="planCandidates.length"
                  class="space-y-6"
                >
                  <article
                    v-for="(candidate, index) in planCandidates"
                    :key="candidate.title + index"
                    class="rounded-2xl border border-slate-800 bg-slate-950/70 p-6 shadow-2xl shadow-primary-900/15 space-y-6"
                  >
                    <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                      <div class="space-y-2">
                        <p class="text-xs font-semibold uppercase tracking-wide text-primary-200">
                          Candidate {{ index + 1 }}
                        </p>
                        <h4 class="text-2xl font-semibold text-white">{{ candidate.title || "Untitled Recipe" }}</h4>
                        <p class="text-sm text-slate-300">
                          {{ describeCandidate(candidate) }}
                        </p>
                      </div>
                    <div class="flex flex-wrap gap-2 text-xs font-semibold text-slate-100">
                      <span class="rounded-full bg-slate-800 px-3 py-1">
                        ‚è±Ô∏è {{ candidate.estimated_time_min != null ? candidate.estimated_time_min + " min" : "Flexible prep" }}
                      </span>
                      <span class="rounded-full bg-slate-800 px-3 py-1">
                        üçΩÔ∏è {{ targetServingsLabel(candidate) }}
                      </span>
                      <template v-if="candidate.macros_per_serving">
                        <span class="rounded-full bg-emerald-900/40 px-3 py-1">
                          üî• {{ formatNumber(candidate.macros_per_serving.kcal) || "‚Äî" }} kcal
                        </span>
                        <span class="rounded-full bg-emerald-900/40 px-3 py-1">
                          üí™ {{ formatNumber(candidate.macros_per_serving.protein_g) || "‚Äî" }} g protein
                        </span>
                      </template>
                      <button
                        type="button"
                        @click="saveCandidateToMeals(candidate)"
                        :disabled="isCandidateSaving(candidate)"
                        class="inline-flex items-center gap-2 rounded-full border border-primary-500/60 bg-primary-500/10 px-3 py-1 text-xs font-semibold text-primary-100 transition hover:bg-primary-500/20 disabled:cursor-not-allowed disabled:opacity-70"
                      >
                        <span class="i-lucide-save"></span>
                        <span>{{ isCandidateSaving(candidate) ? "Saving‚Ä¶" : "Add to Meals" }}</span>
                      </button>
                    </div>
                    <div
                      v-if="candidate.diagnostics && candidate.diagnostics.length"
                      class="mt-3 rounded-xl border border-indigo-500/40 bg-indigo-500/10 p-3 text-xs text-indigo-100"
                    >
                      <p class="font-semibold uppercase tracking-wide text-indigo-200">
                        Diagnostics
                      </p>
                      <ul class="mt-2 space-y-1">
                        <li v-for="(note, noteIndex) in candidate.diagnostics" :key="noteIndex">
                          {{ note }}
                        </li>
                      </ul>
                    </div>
                  </div>
                    <div class="grid gap-6 md:grid-cols-2">
                      <div>
                        <h5 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
                          Ingredients for {{ targetServingsLabel(candidate) }}
                        </h5>
                        <ul class="mt-3 space-y-2 text-sm text-slate-100">
                          <li
                            v-for="req in candidate.ingredients_required"
                            :key="req.name + (req.ingredient_id ?? '')"
                            class="flex items-start gap-3"
                          >
                            <span class="mt-1 h-2 w-2 rounded-full bg-primary-500"></span>
                            <span>{{ formatRequirement(req, candidate) }}</span>
                          </li>
                        </ul>
                        <div
                          v-if="candidate.shopping_shortfall && candidate.shopping_shortfall.length"
                          class="mt-4 rounded-xl border border-amber-500/40 bg-amber-500/10 p-4 text-sm text-amber-100"
                        >
                          <p class="font-semibold uppercase tracking-wide text-xs text-amber-200">
                            Shopping List
                          </p>
                          <ul class="mt-2 space-y-1">
                            <li
                              v-for="short in candidate.shopping_shortfall"
                              :key="short.name + short.reason"
                              class="flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between"
                            >
                              <span>{{ formatShortfall(short) }}</span>
                              <button
                                type="button"
                                @click="addShortfallToShoppingList(candidate, short)"
                                :disabled="isShoppingItemAdding(candidate, short)"
                                class="inline-flex items-center gap-1 rounded-full border border-amber-400/60 bg-amber-500/10 px-3 py-1 text-xs font-semibold text-amber-100 transition hover:bg-amber-500/20 disabled:cursor-not-allowed disabled:opacity-60"
                              >
                                <span>{{ isShoppingItemAdding(candidate, short) ? "Adding‚Ä¶" : "Add to Shopping List" }}</span>
                              </button>
                            </li>
                          </ul>
                        </div>
                      </div>
                      <div>
                        <h5 class="text-sm font-semibold uppercase tracking-wide text-slate-400">
                          Step-by-step
                        </h5>
                        <ol class="mt-3 space-y-2 text-sm text-slate-100">
                          <li
                            v-for="(step, stepIndex) in candidate.steps"
                            :key="stepIndex"
                            class="flex gap-3"
                          >
                            <span class="font-semibold text-primary-300">{{ stepIndex + 1 }}.</span>
                            <span>{{ formatStep(step) }}</span>
                          </li>
                        </ol>
                        <div
                          v-if="candidate.inventory_deltas && candidate.inventory_deltas.length"
                          class="mt-4 rounded-xl border border-emerald-500/40 bg-emerald-500/10 p-4 text-sm text-emerald-100"
                        >
                          <p class="font-semibold uppercase tracking-wide text-xs text-emerald-200">
                            Inventory Impact
                          </p>
                          <ul class="mt-2 space-y-1">
                            <li
                              v-for="delta in candidate.inventory_deltas"
                              :key="delta.ingredient_id + '-' + (delta.use_g ?? delta.use_ml ?? delta.use_count ?? '0')"
                            >
                              {{ formatInventoryDelta(delta) }}
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </article>
                </div>

                <div
                  v-else
                  class="rounded-2xl border border-dashed border-slate-700 bg-slate-900/40 p-6 text-center text-sm text-slate-300"
                >
                  Waiting for plan‚Ä¶ Generate a plan to view the recipes.
                </div>

                <div
                  v-if="planner.showRaw && formattedPlan"
                  class="rounded-2xl border border-slate-800 bg-slate-950/80 p-4 font-mono text-xs leading-6 text-slate-100 shadow-inner"
                >
                  <pre class="whitespace-pre-wrap break-words">{{ formattedPlan }}</pre>
                </div>
              </div>
            </div>
          </section>

          <!-- Inventory -->
          <section
            v-if="currentTab === 'inventory'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-2">
              <div class="flex flex-col gap-4">
                <header>
                  <h2 class="text-xl font-semibold text-white">Add Inventory Item</h2>
                  <p class="text-sm text-slate-300">
                    Track pantry items and update quantities as you cook.
                  </p>
                </header>
                <form @submit.prevent="createInventoryItem" class="grid gap-4">
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Item Name</label>
                    <input
                      v-model="inventory.form.name"
                      type="text"
                      required
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="e.g., canned tomatoes"
                    />
                  </div>
                  <div class="grid gap-4 sm:grid-cols-2">
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Quantity</label>
                      <input
                        v-model="inventory.form.quantity"
                        type="number"
                        min="0"
                        step="0.1"
                        required
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        placeholder="4"
                      />
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Unit</label>
                      <input
                        v-model="inventory.form.unit"
                        type="text"
                        required
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        placeholder="can"
                      />
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Best Before (optional)</label>
                    <input
                      v-model="inventory.form.best_before"
                      type="date"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                    />
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Notes (optional)</label>
                    <textarea
                      v-model="inventory.form.notes"
                      rows="2"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="Any additional notes‚Ä¶"
                    ></textarea>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm" :class="inventory.statusColor">{{ inventory.status }}</p>
                    <button
                      type="submit"
                      :disabled="inventory.loading"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                    >
                      <span class="i-lucide-plus"></span>
                      <span>{{ inventory.loading ? "Saving‚Ä¶" : "Add Item" }}</span>
                    </button>
                  </div>
                </form>
              </div>
              <div class="flex flex-col gap-4">
                <header class="flex items-center justify-between">
                  <div>
                    <h3 class="text-xl font-semibold text-white">Inventory Items</h3>
                    <p class="text-sm text-slate-300">
                      Edit quantities inline or remove items you no longer track.
                    </p>
                  </div>
                  <button
                    @click="loadInventory"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
                  >
                    <span class="i-lucide-refresh-cw"></span>
                    <span>Reload</span>
                  </button>
                </header>
                <div v-if="inventory.items.length === 0" class="rounded-xl border border-dashed border-slate-700 bg-slate-900/40 p-6 text-center text-sm text-slate-300">
                  No inventory items yet. Add your first ingredient to get started.
                </div>
                <div v-else class="grid gap-4">
                  <div
                    v-for="item in inventory.items"
                    :key="item.id"
                    class="rounded-xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/30"
                  >
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                      <div class="space-y-2">
                        <div class="flex items-center gap-2">
                          <span class="rounded-lg bg-primary-600/20 px-2 py-0.5 text-xs font-medium text-primary-100">#{{ item.id }}</span>
                          <h4 class="text-base font-semibold text-white">{{ item.name }}</h4>
                        </div>
                        <div class="grid gap-2 sm:grid-cols-3">
                          <label class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-slate-400">
                            Quantity
                            <input
                              v-model="item.editQuantity"
                              type="number"
                              min="0"
                              step="0.1"
                              class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                            />
                          </label>
                          <div class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-slate-400">
                            Unit
                            <div class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-200">
                              {{ item.unit || "‚Äî" }}
                            </div>
                          </div>
                          <div class="flex flex-col gap-1 text-xs font-medium uppercase tracking-wide text-slate-400">
                            Best Before
                            <div class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-200">
                              {{ item.best_before || "‚Äî" }}
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button
                          @click="updateInventoryItem(item)"
                          class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-primary-500"
                        >
                          <span class="i-lucide-save"></span>
                          <span>Save</span>
                        </button>
                        <button
                          @click="deleteInventoryItem(item)"
                          class="inline-flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-200 transition hover:bg-red-500/20"
                        >
                          <span class="i-lucide-trash"></span>
                          <span>Delete</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Shopping List -->
          <section
            v-if="currentTab === 'shopping'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-[1fr,2fr]">
              <div class="flex flex-col gap-4">
                <header class="space-y-2">
                  <h2 class="text-xl font-semibold text-white">Smart Shopping List</h2>
                  <p class="text-sm text-slate-300">
                    The rat chef‚Äôs mise en place: keep a lightweight checklist, push shortages from plans, and restock with a tap.
                  </p>
                  <p class="text-xs" :class="shopping.statusColor">{{ shopping.status }}</p>
                  <div
                    v-if="shopping.reminder"
                    class="rounded-xl border border-amber-500/40 bg-amber-500/10 px-4 py-3 text-sm text-amber-100"
                  >
                    {{ shopping.reminder }}
                  </div>
                </header>
                <form
                  @submit.prevent="createShoppingItem"
                  class="grid gap-4 rounded-2xl border border-slate-800 bg-slate-950/40 p-4"
                >
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Item name</label>
                    <input
                      v-model="shopping.form.name"
                      type="text"
                      required
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="e.g., salmon fillets"
                    />
                  </div>
                  <div class="grid gap-4 sm:grid-cols-2">
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Quantity (optional)</label>
                      <input
                        v-model="shopping.form.quantity"
                        type="number"
                        min="0"
                        step="0.1"
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        placeholder="2"
                      />
                    </div>
                    <div class="flex flex-col gap-2">
                      <label class="text-sm font-medium text-slate-200">Unit</label>
                      <input
                        v-model="shopping.form.unit"
                        type="text"
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                        placeholder="ea, g, ml‚Ä¶"
                      />
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Notes</label>
                    <textarea
                      v-model="shopping.form.notes"
                      rows="2"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="Brand, aisle, reminder‚Ä¶"
                    ></textarea>
                  </div>
                  <button
                    type="submit"
                    :disabled="shopping.loading"
                    class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                  >
                    <span class="i-lucide-plus"></span>
                    <span>{{ shopping.loading ? "Saving‚Ä¶" : "Add to List" }}</span>
                  </button>
                </form>
                <div class="rounded-2xl border border-slate-800 bg-slate-950/30 p-4">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-400">Quick actions</h3>
                      <p class="text-xs text-slate-500">One tap reset + manual refresh when offline.</p>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button
                        type="button"
                        @click="resetShoppingList"
                        :disabled="shopping.loading"
                        class="inline-flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-xs font-semibold text-red-100 transition hover:bg-red-500/20 disabled:cursor-not-allowed"
                      >
                        <span>Reset List</span>
                      </button>
                      <button
                        type="button"
                        @click="loadShoppingList"
                        :disabled="shopping.loading"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-xs font-semibold text-slate-200 transition hover:bg-slate-800 disabled:cursor-not-allowed"
                      >
                        <span>Refresh</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <div class="space-y-6">
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-semibold text-white">In your cart</h3>
                      <p class="text-xs text-slate-400">Tap the checkbox as you pick things up.</p>
                    </div>
                    <span class="text-sm text-slate-400">{{ shoppingActiveItems.length }} active</span>
                  </div>
                  <div
                    v-if="!shoppingActiveItems.length"
                    class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-400"
                  >
                    All caught up. Add any missing ingredients before you head out.
                  </div>
                  <div
                    v-for="item in shoppingActiveItems"
                    :key="`shopping-active-${item.id}`"
                    class="rounded-2xl border border-slate-800 bg-slate-950/70 p-4 shadow-lg shadow-slate-900/20 space-y-3"
                  >
                    <div class="flex items-start gap-3">
                      <button
                        type="button"
                        @click="toggleShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="mt-1 inline-flex h-9 w-9 items-center justify-center rounded-full border border-slate-700 bg-slate-900 text-lg text-slate-200 transition hover:bg-slate-800 disabled:cursor-not-allowed"
                      >
                        <span class="i-lucide-check" v-if="item.is_checked"></span>
                        <span v-else>‚óã</span>
                      </button>
                      <div class="flex-1 space-y-1">
                        <div class="flex items-center justify-between gap-3">
                          <h4 class="text-lg font-semibold text-white">{{ item.name }}</h4>
                          <span class="rounded-full bg-slate-800 px-2 py-0.5 text-xs text-slate-300">
                            {{ formatShoppingQuantity(item) || "as needed" }}
                          </span>
                        </div>
                        <p v-if="item.notes" class="text-xs text-slate-400">{{ item.notes }}</p>
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button
                        type="button"
                        @click="addShoppingItemToInventory(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg bg-green-600/80 px-3 py-2 text-sm font-semibold text-white transition hover:bg-green-500 disabled:cursor-not-allowed disabled:opacity-70"
                      >
                        <span class="i-lucide-plus"></span>
                        <span>Add to Inventory</span>
                      </button>
                      <button
                        type="button"
                        @click="toggleShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800 disabled:cursor-not-allowed"
                      >
                        <span>{{ item.is_checked ? "Mark Active" : "Mark Done" }}</span>
                      </button>
                      <button
                        type="button"
                        @click="deleteShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-100 transition hover:bg-red-500/20 disabled:cursor-not-allowed"
                      >
                        <span class="i-lucide-trash"></span>
                        <span>Delete</span>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="space-y-3">
                  <div class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-semibold text-white">Checked off</h3>
                      <p class="text-xs text-slate-400">Reopen or push to inventory later.</p>
                    </div>
                    <span class="text-sm text-slate-400">{{ shoppingCompletedItems.length }} done</span>
                  </div>
                  <div
                    v-if="!shoppingCompletedItems.length"
                    class="rounded-2xl border border-slate-800 bg-slate-950/40 p-4 text-sm text-slate-400"
                  >
                    Nothing checked off yet‚Äîmark items as you shop.
                  </div>
                  <div
                    v-for="item in shoppingCompletedItems"
                    :key="`shopping-complete-${item.id}`"
                    class="rounded-2xl border border-slate-800 bg-slate-950/30 p-4 space-y-3 opacity-80"
                  >
                    <div class="flex items-start gap-3">
                      <button
                        type="button"
                        @click="toggleShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="mt-1 inline-flex h-9 w-9 items-center justify-center rounded-full border border-green-500/60 bg-green-500/10 text-lg text-green-200 transition hover:bg-green-500/20 disabled:cursor-not-allowed"
                      >
                        <span class="i-lucide-check"></span>
                      </button>
                      <div class="flex-1 space-y-1">
                        <div class="flex items-center justify-between gap-3">
                          <h4 class="text-base font-semibold text-slate-200">{{ item.name }}</h4>
                          <span class="rounded-full bg-slate-900 px-2 py-0.5 text-xs text-slate-300">
                            {{ formatShoppingQuantity(item) || "as needed" }}
                          </span>
                        </div>
                        <p v-if="item.notes" class="text-xs text-slate-500">{{ item.notes }}</p>
                      </div>
                    </div>
                    <div class="flex flex-wrap gap-2">
                      <button
                        type="button"
                        @click="addShoppingItemToInventory(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg bg-green-600/80 px-3 py-2 text-sm font-semibold text-white transition hover:bg-green-500 disabled:cursor-not-allowed disabled:opacity-70"
                      >
                        <span class="i-lucide-plus"></span>
                        <span>Add to Inventory</span>
                      </button>
                      <button
                        type="button"
                        @click="toggleShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800 disabled:cursor-not-allowed"
                      >
                        <span>Mark Active</span>
                      </button>
                      <button
                        type="button"
                        @click="deleteShoppingItem(item)"
                        :disabled="isShoppingItemBusy(item.id)"
                        class="inline-flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-100 transition hover:bg-red-500/20 disabled:cursor-not-allowed"
                      >
                        <span class="i-lucide-trash"></span>
                        <span>Delete</span>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Preferences -->
          <section
            v-if="currentTab === 'preferences'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-[2fr,3fr]">
              <div class="flex flex-col gap-4">
                <header>
                  <h2 class="text-xl font-semibold text-white">Household Preferences</h2>
                  <p class="text-sm text-slate-300">
                    Set dietary preferences, prep time constraints, and allergen information.
                  </p>
                </header>
                <form @submit.prevent="savePreferences" class="grid gap-4">
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Dietary Preference</label>
                    <input
                      v-model="preferences.form.diet"
                      type="text"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="e.g., vegetarian"
                    />
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Max Prep Time (minutes)</label>
                    <input
                      v-model.number="preferences.form.max_time_min"
                      type="number"
                      min="0"
                      max="240"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="e.g., 45"
                    />
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Allergens (comma-separated)</label>
                    <textarea
                      v-model="preferences.form.allergensText"
                      rows="3"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="peanut, shellfish"
                    ></textarea>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm" :class="preferences.statusColor">{{ preferences.status }}</p>
                    <button
                      type="submit"
                      :disabled="preferences.loading"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                    >
                      <span class="i-lucide-save"></span>
                      <span>{{ preferences.loading ? "Saving‚Ä¶" : "Save Preferences" }}</span>
                    </button>
                  </div>
                </form>
              </div>
              <div class="flex flex-col gap-4">
                <header>
                  <h3 class="text-lg font-semibold text-white">Current Preferences</h3>
                  <p class="text-sm text-slate-300">
                    Live snapshot pulled from the Remy API.
                  </p>
                </header>
                <dl class="grid gap-4 rounded-2xl border border-slate-800 bg-slate-950/60 p-5">
                  <div>
                    <dt class="text-xs font-semibold uppercase tracking-wide text-slate-400">Diet</dt>
                    <dd class="text-sm text-slate-100">{{ preferences.view.diet || "‚Äî" }}</dd>
                  </div>
                  <div>
                    <dt class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                      Max Prep Time
                    </dt>
                    <dd class="text-sm text-slate-100">
                      {{ preferences.view.max_time_min != null ? preferences.view.max_time_min + " min" : "‚Äî" }}
                    </dd>
                  </div>
                  <div>
                    <dt class="text-xs font-semibold uppercase tracking-wide text-slate-400">
                      Allergens
                    </dt>
                    <dd class="text-sm text-slate-100">
                      {{ preferences.view.allergens && preferences.view.allergens.length
                        ? preferences.view.allergens.join(", ")
                        : "‚Äî" }}
                    </dd>
                  </div>
                </dl>
              </div>
            </div>
          </section>

          <!-- Receipts -->
          <section
            v-if="currentTab === 'receipts'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-2">
              <div class="flex flex-col gap-4">
                <header>
                  <h2 class="text-xl font-semibold text-white">Upload Receipt</h2>
                  <p class="text-sm text-slate-300">
                    Store grocery receipts for local OCR processing and inventory ingestion.
                  </p>
                </header>
                <form id="receipt-form" @submit.prevent="uploadReceipt" class="grid gap-4">
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Receipt File</label>
                    <input
                      @change="handleReceiptFile"
                      type="file"
                      accept="image/*,application/pdf"
                      required
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                    />
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Notes (optional)</label>
                    <textarea
                      v-model="receipts.upload.notes"
                      rows="2"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="Weekly grocery run"
                    ></textarea>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm" :class="receipts.statusColor">{{ receipts.status }}</p>
                    <button
                      type="submit"
                      :disabled="receipts.loading"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                    >
                      <span class="i-lucide-upload"></span>
                      <span>{{ receipts.loading ? "Uploading‚Ä¶" : "Upload Receipt" }}</span>
                    </button>
                  </div>
                </form>
              </div>
              <div class="flex flex-col gap-4">
                <header class="flex items-center justify-between">
                  <div>
                    <h3 class="text-lg font-semibold text-white">Stored Receipts</h3>
                    <p class="text-sm text-slate-300">
                      Download originals or review metadata before OCR parsing.
                    </p>
                  </div>
                  <button
                    @click="loadReceipts"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
                  >
                    <span class="i-lucide-refresh-cw"></span>
                    <span>Reload</span>
                  </button>
                </header>
                <div v-if="receipts.items.length === 0" class="rounded-xl border border-dashed border-slate-700 bg-slate-900/40 p-6 text-center text-sm text-slate-300">
                  No receipts uploaded yet. Add a receipt to start OCR ingestion.
                </div>
                <div v-else class="grid gap-4">
                  <div
                    v-for="receipt in receipts.items"
                    :key="receipt.id"
                    class="rounded-xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/30 space-y-4"
                  >
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                      <div class="space-y-2">
                        <div class="flex flex-wrap items-center gap-2">
                          <span class="rounded-lg bg-primary-600/20 px-2 py-0.5 text-xs font-medium text-primary-100">#{{ receipt.id }}</span>
                          <h4 class="text-base font-semibold text-white">{{ receipt.filename }}</h4>
                        </div>
                        <dl class="grid gap-2 text-sm text-slate-300">
                          <div class="flex gap-2">
                            <dt class="min-w-[90px] text-xs font-semibold uppercase tracking-wide text-slate-400">Size</dt>
                            <dd>{{ formatSize(receipt.size_bytes) }}</dd>
                          </div>
                          <div class="flex gap-2">
                            <dt class="min-w-[90px] text-xs font-semibold uppercase tracking-wide text-slate-400">Uploaded</dt>
                            <dd>{{ formatDateTime(receipt.uploaded_at) }}</dd>
                          </div>
                          <div class="flex gap-2">
                            <dt class="min-w-[90px] text-xs font-semibold uppercase tracking-wide text-slate-400">Notes</dt>
                            <dd>{{ receipt.notes || "‚Äî" }}</dd>
                          </div>
                        </dl>
                      </div>
                      <div class="flex flex-wrap gap-2">
                        <a
                          :href="`/receipts/${receipt.id}/download`"
                          class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800"
                        >
                          <span class="i-lucide-download"></span>
                          <span>Download</span>
                        </a>
                        <button
                          @click="runReceiptOcr(receipt)"
                          :disabled="isReceiptProcessing(receipt.id)"
                          class="inline-flex items-center gap-2 rounded-lg border border-primary-600/50 bg-primary-600/20 px-3 py-2 text-sm font-semibold text-primary-100 transition hover:bg-primary-500/30 disabled:cursor-not-allowed disabled:opacity-60"
                        >
                          <span class="i-lucide-scan-text"></span>
                          <span>{{ isReceiptProcessing(receipt.id) ? "Processing‚Ä¶" : "Run OCR" }}</span>
                        </button>
                        <button
                          v-if="receipt.ocr && receipt.ocr.text"
                          @click="toggleReceiptExpansion(receipt.id)"
                          class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800"
                        >
                          <span :class="isReceiptExpanded(receipt.id) ? 'i-lucide-eye-off' : 'i-lucide-eye'"></span>
                          <span>{{ isReceiptExpanded(receipt.id) ? "Hide Text" : "View Text" }}</span>
                        </button>
                        <button
                          @click="deleteReceipt(receipt)"
                          class="inline-flex items-center gap-2 rounded-lg border border-red-500/50 bg-red-500/10 px-3 py-2 text-sm font-semibold text-red-200 transition hover:bg-red-500/20"
                        >
                          <span class="i-lucide-trash"></span>
                          <span>Delete</span>
                        </button>
                      </div>
                    </div>
                    <div class="rounded-lg border border-slate-800 bg-slate-900/50 p-3">
                      <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
                        <div class="space-y-1">
                          <p class="text-sm text-slate-200">
                            <span class="text-xs uppercase tracking-wide text-slate-400">Status</span>
                            <span class="ml-2 font-medium" :class="ocrStatusClass(receipt.ocr?.status)">
                              {{ ocrStatusLabel(receipt.ocr?.status) }}
                            </span>
                          </p>
                          <p v-if="receipt.ocr && receipt.ocr.confidence != null" class="text-sm text-slate-300">
                            Confidence: {{ formatConfidence(receipt.ocr.confidence) }}
                          </p>
                          <p v-if="receipt.ocr && receipt.ocr.metadata?.word_count" class="text-xs text-slate-400">
                            Words detected: {{ receipt.ocr.metadata.word_count }}
                          </p>
                          <p v-if="receipt.ocr && receipt.ocr.error_message" class="text-xs text-red-300">
                            Error: {{ receipt.ocr.error_message }}
                          </p>
                        </div>
                        <div
                          v-if="receipt.ocr && receipt.ocr.text && !isReceiptExpanded(receipt.id)"
                          class="text-xs text-slate-400 sm:max-w-xs"
                        >
                          <span class="font-semibold text-slate-300">Preview:</span>
                          <span>{{ summarizeOcrText(receipt.ocr.text) }}</span>
                        </div>
                      </div>
                      <pre
                        v-if="receipt.ocr && receipt.ocr.text && isReceiptExpanded(receipt.id)"
                        class="mt-3 max-h-48 overflow-auto rounded-lg bg-slate-950/70 p-3 text-xs leading-5 text-slate-100"
                      >{{ receipt.ocr.text }}</pre>
                      <div
                        v-if="parsedItems(receipt).length"
                        class="mt-4 space-y-4 rounded-lg border border-slate-800 bg-slate-950/50 p-4"
                      >
                        <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                          <div>
                            <h5 class="text-sm font-semibold text-slate-200">Parsed Items</h5>
                            <p class="text-xs text-slate-400">
                              Approve items to add or update inventory. Edit quantities or names before submitting.
                            </p>
                          </div>
                          <button
                            @click="approveReceiptItems(receipt)"
                            :disabled="receipts.submitting[receipt.id]"
                            class="inline-flex items-center gap-2 rounded-lg bg-green-600 px-3 py-2 text-sm font-semibold text-white transition hover:bg-green-500 disabled:cursor-not-allowed disabled:opacity-60"
                          >
                            <span class="i-lucide-plus"></span>
                            <span>{{ receipts.submitting[receipt.id] ? "Saving‚Ä¶" : "Approve Selected" }}</span>
                          </button>
                        </div>
                        <div
                          v-if="ingestedItems(receipt).length"
                          class="rounded-lg border border-green-500/30 bg-green-500/10 p-3 text-xs text-green-100"
                        >
                          <strong class="text-green-200">Previously ingested:</strong>
                          <span>
                            {{ ingestedItems(receipt).map((entry) => `${entry.name} (${entry.quantity ?? '‚Äî'})`).join(", ") }}
                          </span>
                        </div>
                        <div class="space-y-3">
                          <div
                            v-for="(item, index) in receiptSelection(receipt.id)"
                            :key="index"
                            class="rounded-lg border border-slate-800 bg-slate-900/70 p-3"
                          >
                            <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                              <label class="flex items-start gap-3 text-sm text-slate-200">
                                <input type="checkbox" v-model="item.selected" class="mt-1 h-4 w-4 rounded border-slate-700 bg-slate-900" />
                                <span>Include</span>
                              </label>
                              <div class="grid flex-1 gap-3 sm:grid-cols-4">
                                <div class="flex flex-col gap-1 sm:col-span-2">
                                  <label class="text-xs uppercase tracking-wide text-slate-400">Name</label>
                                  <input
                                    v-model="item.name"
                                    type="text"
                                    class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                                  />
                                  <p v-if="item.inventory_match_name" class="text-xs text-primary-200">
                                    Suggested match: {{ item.inventory_match_name }}
                                  </p>
                                </div>
                                <div class="flex flex-col gap-1">
                                  <label class="text-xs uppercase tracking-wide text-slate-400">Quantity</label>
                                  <input
                                    v-model.number="item.quantity"
                                    type="number"
                                    min="0"
                                    step="0.01"
                                    class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                                  />
                                </div>
                                <div class="flex flex-col gap-1">
                                  <label class="text-xs uppercase tracking-wide text-slate-400">Unit</label>
                                  <input
                                    v-model="item.unit"
                                    type="text"
                                    class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                                  />
                                </div>
                                <div class="flex flex-col gap-1">
                                  <label class="text-xs uppercase tracking-wide text-slate-400">Notes</label>
                                  <input
                                    v-model="item.notes"
                                    type="text"
                                    class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                                  />
                                </div>
                              </div>
                            </div>
                            <p v-if="item.raw?.confidence != null" class="mt-2 text-xs text-slate-400">
                              Confidence: {{ Math.round(item.raw.confidence * 100) }}%
                            </p>
                            <p class="mt-1 text-xs text-slate-500">
                              Raw: {{ item.raw?.raw_text || item.raw?.name || "‚Äî" }}
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="mt-6 space-y-4">
                  <header class="flex items-center justify-between">
                    <div>
                      <h3 class="text-lg font-semibold text-white">Pending Suggestions</h3>
                      <p class="text-sm text-slate-300">
                        These items need review before they can be added to inventory.
                      </p>
                    </div>
                    <button
                      @click="loadSuggestions"
                      class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
                    >
                      <span class="i-lucide-refresh-cw"></span>
                      <span>Reload</span>
                    </button>
                  </header>
                  <p class="text-xs" :class="inventory.suggestionStatusColor">
                    {{ inventory.suggestionStatus }}
                  </p>
                  <div
                    v-if="inventory.suggestions.length === 0"
                    class="rounded-xl border border-dashed border-slate-700 bg-slate-900/40 p-4 text-sm text-slate-300"
                  >
                    No pending suggestions. Approve items from receipts to populate this list when confidence is low.
                  </div>
                  <div v-else class="grid gap-4">
                    <div
                      v-for="suggestion in inventory.suggestions"
                      :key="suggestion.id"
                      class="rounded-xl border border-slate-800 bg-slate-950/60 p-4"
                    >
                      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                        <div class="space-y-2">
                          <div class="flex items-center gap-2">
                            <span class="rounded-lg bg-yellow-500/20 px-2 py-0.5 text-xs font-medium text-yellow-100">Suggestion #{{ suggestion.id }}</span>
                            <h4 class="text-base font-semibold text-white">{{ suggestion.name }}</h4>
                          </div>
                          <dl class="grid gap-2 text-xs text-slate-300 sm:grid-cols-3">
                            <div>
                              <dt class="uppercase tracking-wide text-slate-400">Quantity</dt>
                              <dd>{{ suggestion.quantity ?? "‚Äî" }}</dd>
                            </div>
                            <div>
                              <dt class="uppercase tracking-wide text-slate-400">Unit</dt>
                              <dd>{{ suggestion.unit ?? "‚Äî" }}</dd>
                            </div>
                            <div>
                              <dt class="uppercase tracking-wide text-slate-400">Confidence</dt>
                              <dd>{{ suggestion.confidence != null ? Math.round(suggestion.confidence * 100) + "%" : "‚Äî" }}</dd>
                            </div>
                          </dl>
                        </div>
                        <div class="flex gap-2">
                          <button
                            @click="approveSuggestion(suggestion)"
                            class="inline-flex items-center gap-2 rounded-lg border border-green-500/60 bg-green-500/20 px-3 py-2 text-sm font-semibold text-green-100 transition hover:bg-green-500/30"
                          >
                            <span class="i-lucide-check"></span>
                            <span>Approve</span>
                          </button>
                          <button
                            @click="dismissSuggestion(suggestion.id)"
                            class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm font-semibold text-slate-100 transition hover:bg-slate-800"
                          >
                            <span class="i-lucide-eye-off"></span>
                            <span>Dismiss</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Meals -->
          <section
            v-if="currentTab === 'meals'"
            class="rounded-2xl border border-slate-800 bg-slate-900/60 shadow-2xl shadow-primary-900/10 backdrop-blur-sm"
          >
            <div class="grid gap-6 p-6 lg:grid-cols-2">
              <div class="flex flex-col gap-4">
                <header>
                  <h2 class="text-xl font-semibold text-white">Add Meal Entry</h2>
                  <p class="text-sm text-slate-300">Capture ratings and notes to improve future recommendations.</p>
                </header>
                <form @submit.prevent="addMeal" class="grid gap-4">
                  <div class="grid gap-4 sm:grid-cols-2">
                    <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                      Date
                      <input
                        v-model="meals.form.date"
                        type="date"
                        required
                        class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      />
                    </label>
                    <div class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                      Rating
                      <div class="flex items-center gap-1">
                        <button
                          v-for="star in 5"
                          :key="star"
                          type="button"
                          @click="meals.form.rating = star"
                          class="text-2xl transition"
                          :class="star <= Number(meals.form.rating) ? 'text-yellow-300' : 'text-slate-600'"
                        >
                          ‚òÖ
                        </button>
                        <button
                          type="button"
                          @click="meals.form.rating = ''"
                          class="text-xs text-slate-400 underline"
                        >
                          Clear
                        </button>
                      </div>
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Meal Title</label>
                    <input
                      v-model="meals.form.title"
                      type="text"
                      required
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="e.g., Chickpea Coconut Curry"
                    />
                  </div>
                  <div class="flex flex-col gap-2">
                    <label class="text-sm font-medium text-slate-200">Notes</label>
                    <textarea
                      v-model="meals.form.notes"
                      rows="2"
                      class="rounded-lg border border-slate-800 bg-slate-950/70 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                      placeholder="What worked? What would you change next time?"
                    ></textarea>
                  </div>
                  <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
                    <p class="text-sm" :class="meals.statusColor">{{ meals.status }}</p>
                    <button
                      type="submit"
                      :disabled="meals.loading"
                      class="inline-flex items-center justify-center gap-2 rounded-xl bg-primary-600 px-5 py-2.5 text-sm font-semibold text-white transition hover:bg-primary-500 disabled:cursor-not-allowed disabled:bg-primary-900"
                    >
                      <span class="i-lucide-plus"></span>
                      <span>{{ meals.loading ? "Saving‚Ä¶" : "Save Meal" }}</span>
                    </button>
                  </div>
                </form>
              </div>
              <div class="flex flex-col gap-4">
                <header class="flex items-center justify-between">
                  <div>
                    <h3 class="text-lg font-semibold text-white">Meal History</h3>
                    <p class="text-sm text-slate-300">Update ratings or notes to refine future suggestions.</p>
                  </div>
                  <button
                    @click="loadMeals"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-700 bg-slate-800 px-3 py-2 text-sm font-medium text-slate-200 hover:bg-slate-700"
                  >
                    <span class="i-lucide-refresh-cw"></span>
                    <span>Reload</span>
                  </button>
                </header>
                <div v-if="meals.items.length === 0" class="rounded-xl border border-dashed border-slate-700 bg-slate-900/40 p-6 text-center text-sm text-slate-300">
                  No meals recorded yet. Add your first review to start building history.
                </div>
                <div v-else class="space-y-4">
                  <div
                    v-for="meal in meals.items"
                    :key="meal.date + meal.title"
                    class="rounded-xl border border-slate-800 bg-slate-950/60 p-4 shadow-lg shadow-slate-900/30"
                  >
                    <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
                      <div class="space-y-1">
                        <div class="flex items-center gap-2">
                          <span class="rounded-lg bg-primary-600/20 px-2 py-0.5 text-xs font-medium text-primary-100">{{ meal.date }}</span>
                          <h4 class="text-base font-semibold text-white">{{ meal.title }}</h4>
                        </div>
                        <div class="grid gap-3 sm:grid-cols-2">
                          <div class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
                            Rating
                            <div class="flex items-center gap-1">
                              <button
                                v-for="star in 5"
                                :key="star"
                                type="button"
                                @click="meal.editRating = star"
                                class="text-xl transition"
                                :class="star <= Number(meal.editRating) ? 'text-yellow-300' : 'text-slate-600'"
                              >
                                ‚òÖ
                              </button>
                              <button
                                type="button"
                                @click="meal.editRating = ''"
                                class="text-xs text-slate-400 underline"
                              >
                                Clear
                              </button>
                            </div>
                          </div>
                          <label class="flex flex-col gap-1 text-xs font-semibold uppercase tracking-wide text-slate-400">
                            Notes
                            <textarea
                              v-model="meal.editNotes"
                              rows="2"
                              class="rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-100 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500/40"
                            ></textarea>
                          </label>
                        </div>
                      </div>
                      <div class="flex gap-2">
                        <button
                          @click="saveMeal(meal)"
                          class="inline-flex items-center gap-2 rounded-lg border border-green-500/60 bg-green-500/20 px-3 py-2 text-sm font-semibold text-green-100 transition hover:bg-green-500/30"
                        >
                          <span class="i-lucide-save"></span>
                          <span>Save</span>
                        </button>
                        <button
                          @click="deleteMeal(meal)"
                          class="inline-flex items-center gap-2 rounded-lg border border-red-500/60 bg-red-500/20 px-3 py-2 text-sm font-semibold text-red-100 transition hover:bg-red-500/30"
                        >
                          <span class="i-lucide-trash"></span>
                          <span>Delete</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>
        </div>
      </main>

      <footer class="border-t border-slate-800 bg-slate-900/80 backdrop-blur-lg">
        <div class="max-w-6xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-4 text-center text-xs text-slate-400">
          Remy API &middot; Planner, Inventory, Preferences, Receipts &middot; Built with Vue 3 + Tailwind
        </div>
      </footer>
    </div>

    <script>
      const SAMPLE_CONTEXT = JSON.parse(
        document.getElementById("sample-context").textContent || "{}"
      );

      const app = Vue.createApp({
        data() {
          return {
            tabs: [
              { id: "planner", label: "Planner", icon: "‚ú®" },
              { id: "inventory", label: "Inventory", icon: "üß∫" },
              { id: "shopping", label: "Shopping List", icon: "üõí" },
              { id: "preferences", label: "Preferences", icon: "‚öôÔ∏è" },
              { id: "receipts", label: "Receipts", icon: "üßæ" },
              { id: "meals", label: "Meals", icon: "üçΩÔ∏è" },
            ],
            currentTab: "planner",
            token: window.localStorage.getItem("remy_api_token") || "",
            planner: {
              context: JSON.stringify(SAMPLE_CONTEXT, null, 2),
              plan: null,
              status: "Ready to generate a plan.",
              statusColor: "text-slate-300",
              loading: false,
              servingTarget: 2,
              showRaw: false,
              mealSaveState: {},
              shoppingAddState: {},
              form: {
                date: new Date().toISOString().slice(0, 10),
                attendees: 2,
                time_window: "evening",
                diet_override: "",
                allergens_text: "",
                max_time_min: "",
                cuisines_text: "",
                search_enabled: false,
                search_keywords_text: "",
              },
              contextObject: null,
              contextStatus: "Context not assembled yet.",
              contextStatusColor: "text-slate-300",
              contextLoading: false,
              overridesInitialized: false,
            },
            dietOptions: [
              { value: "omnivore", label: "Omnivore" },
              { value: "vegetarian", label: "Vegetarian" },
              { value: "vegan", label: "Vegan" },
              { value: "pescatarian", label: "Pescatarian" },
              { value: "keto", label: "Keto" },
              { value: "mediterranean", label: "Mediterranean" },
              { value: "gluten-free", label: "Gluten-free" },
              { value: "dairy-free", label: "Dairy-free" },
            ],
            preferences: {
              form: {
                diet: "",
                max_time_min: null,
                allergensText: "",
              },
              view: { diet: null, max_time_min: null, allergens: [] },
              status: "Loading preferences‚Ä¶",
              statusColor: "text-slate-300",
              loading: false,
            },
            inventory: {
              items: [],
              form: { name: "", quantity: "", unit: "g", best_before: "", notes: "" },
              status: "Loading inventory‚Ä¶",
              statusColor: "text-slate-300",
              loading: false,
              suggestions: [],
              suggestionStatus: "Loading suggestions‚Ä¶",
              suggestionStatusColor: "text-slate-300",
            },
            shopping: {
              items: [],
              form: { name: "", quantity: "", unit: "ea", notes: "" },
              status: "Loading shopping list‚Ä¶",
              statusColor: "text-slate-300",
              loading: false,
              pending: {},
              reminder: "",
            },
            meals: {
              items: [],
              status: "Loading meals‚Ä¶",
              statusColor: "text-slate-300",
              form: { date: new Date().toISOString().slice(0, 10), title: "", rating: "", notes: "" },
              loading: false,
            },
            receipts: {
              items: [],
              status: "Loading receipts‚Ä¶",
              statusColor: "text-slate-300",
              loading: false,
              upload: { file: null, notes: "" },
              processing: {},
              expanded: {},
              selections: {},
              submitting: {},
            },
          };
        },
        computed: {
          formattedPlan() {
            return this.planner.plan
              ? JSON.stringify(this.planner.plan, null, 2)
              : "";
          },
          formattedContext() {
            return this.planner.context || "Context not assembled yet.";
          },
          planCandidates() {
            const candidates = this.planner.plan?.candidates;
            return Array.isArray(candidates) ? candidates : [];
          },
          planDateLabel() {
            if (!this.planner.plan?.date) {
              return "‚Äî";
            }
            try {
              return new Date(this.planner.plan.date).toLocaleDateString();
            } catch (error) {
              return this.planner.plan.date;
            }
          },
          servingBadge() {
            const value = this.planner.servingTarget;
            if (!value) {
              return "Base servings";
            }
            return `${value} serving${value === 1 ? "" : "s"}`;
          },
          shoppingActiveItems() {
            return this.shopping.items.filter((item) => !item.is_checked);
          },
          shoppingCompletedItems() {
            return this.shopping.items.filter((item) => item.is_checked);
          },
        },
        methods: {
          setTab(tab) {
            this.currentTab = tab;
          },
          promptToken() {
            const current = this.token || "";
            const next = window.prompt("Enter API token (leave blank to clear)", current);
            if (next === null) {
              return;
            }
            const trimmed = next.trim();
            this.token = trimmed;
            if (trimmed) {
              window.localStorage.setItem("remy_api_token", trimmed);
            } else {
              window.localStorage.removeItem("remy_api_token");
            }
          },
          authHeaders(base = {}) {
            if (this.token) {
              return { ...base, Authorization: `Bearer ${this.token}` };
            }
            return base;
          },
          formatSize(bytes) {
            if (bytes >= 1024 * 1024) {
              return `${(bytes / (1024 * 1024)).toFixed(2)} MiB`;
            }
            if (bytes >= 1024) {
              return `${(bytes / 1024).toFixed(1)} KiB`;
            }
            return `${bytes} B`;
          },
          formatDateTime(value) {
            try {
              return new Date(value).toLocaleString();
            } catch (error) {
              return value;
            }
          },
          formatConfidence(value) {
            if (value == null) {
              return "‚Äî";
            }
            return `${Math.round(value * 100)}%`;
          },
          parseCsvList(value) {
            if (!value) {
              return [];
            }
            return value
              .split(",")
              .map((entry) => entry.trim())
              .filter(Boolean);
          },
          ocrStatusLabel(status) {
            const map = {
              pending: "Pending",
              processing: "Processing",
              succeeded: "Completed",
              failed: "Failed",
            };
            return map[status] || "Unknown";
          },
          ocrStatusClass(status) {
            switch (status) {
              case "succeeded":
                return "text-green-300";
              case "processing":
                return "text-primary-200";
              case "failed":
                return "text-red-300";
              default:
                return "text-slate-300";
            }
          },
          summarizeOcrText(text) {
            if (!text) {
              return "";
            }
            const normalized = text.replace(/\s+/g, " ").trim();
            if (normalized.length <= 140) {
              return normalized;
            }
            return `${normalized.slice(0, 137)}‚Ä¶`;
          },
          applySavedPreferenceOverrides() {
            const prefs = this.preferences.view || {};
            this.planner.form.diet_override = prefs?.diet || "";
            this.planner.form.max_time_min =
              prefs?.max_time_min != null && prefs.max_time_min !== ""
                ? String(prefs.max_time_min)
                : "";
            if (Array.isArray(prefs?.allergens) && prefs.allergens.length) {
              this.planner.form.allergens_text = prefs.allergens.join(", ");
            } else {
              this.planner.form.allergens_text = "";
            }
            this.planner.overridesInitialized = true;
          },
          adjustServings(delta) {
            const current = this.planner.servingTarget || 2;
            const next = Math.min(12, Math.max(1, Math.round((current + delta) * 2) / 2));
            this.planner.servingTarget = next;
          },
          initializeServingTarget(plan, payload) {
            const candidateServings = Array.isArray(plan?.candidates)
              ? plan.candidates
                  .map((candidate) => Number(candidate.servings))
                  .find((value) => Number.isFinite(value) && value > 0)
              : null;
            const contextServings = Number(payload?.constraints?.attendees);
            const fallback = candidateServings || contextServings || 2;
            this.planner.servingTarget = Math.max(1, Math.round(fallback * 2) / 2);
          },
          targetServings(candidate) {
            const base = Number(candidate?.servings) || 1;
            const target = Number(this.planner.servingTarget);
            if (!Number.isFinite(target) || target <= 0) {
              return base;
            }
            return target;
          },
          targetServingsLabel(candidate) {
            const value = this.targetServings(candidate);
            return `${value} serving${value === 1 ? "" : "s"}`;
          },
          formatNumber(value) {
            if (!Number.isFinite(value)) {
              return null;
            }
            if (Math.abs(value) >= 10) {
              return Math.round(value).toString();
            }
            return (Math.round(value * 10) / 10).toString();
          },
          scaleValue(value, candidate) {
            if (value == null) {
              return null;
            }
            const base = Number(candidate?.servings) || 1;
            const target = this.targetServings(candidate);
            const factor = target / base;
            return value * factor;
          },
          formatAmount(value, unit) {
            if (value == null) {
              return null;
            }
            const formatted = this.formatNumber(value);
            if (!formatted) {
              return null;
            }
            return unit ? `${formatted} ${unit}` : formatted;
          },
          formatRequirement(req, candidate) {
            const parts = [];
            const maybeAdd = (value, unit) => {
              const scaled = this.scaleValue(value, candidate);
              const amount = this.formatAmount(scaled, unit);
              if (amount) {
                parts.push(amount);
              }
            };
            maybeAdd(req.qty_g, "g");
            maybeAdd(req.qty_ml, "ml");
            maybeAdd(req.qty_count, "count");
            const amount = parts.length ? parts.join(" ‚Ä¢ ") : "as needed";
            const label = req.name || "Ingredient";
            return `${label} ‚Äî ${amount}`;
          },
          formatInventoryDelta(delta) {
            const amount =
              this.formatAmount(delta.use_g, "g") ||
              this.formatAmount(delta.use_ml, "ml") ||
              this.formatAmount(delta.use_count, "count") ||
              "usage recorded";
            const label =
              delta.ingredient_id != null ? `inventory item #${delta.ingredient_id}` : "inventory";
            return `${amount} from ${label}`;
          },
          formatShoppingQuantity(item) {
            if (item.quantity == null && !item.unit) {
              return null;
            }
            const value = item.quantity != null ? this.formatNumber(item.quantity) : null;
            if (!value && !item.unit) {
              return null;
            }
            if (!value) {
              return item.unit;
            }
            return item.unit ? `${value} ${item.unit}` : value;
          },
          computeShoppingReminder(items) {
            if (!Array.isArray(items) || !items.length) {
              return "";
            }
            const now = Date.now();
            const staleAges: number[] = [];
            for (const item of items) {
              if (item.is_checked) {
                continue;
              }
              const createdAt = Date.parse(item.created_at);
              if (Number.isNaN(createdAt)) {
                continue;
              }
              const ageDays = (now - createdAt) / (1000 * 60 * 60 * 24);
              if (ageDays >= 2) {
                staleAges.push(Math.floor(ageDays));
              }
            }
            if (!staleAges.length) {
              return "";
            }
            const oldest = Math.max(...staleAges);
            const count = staleAges.length;
            const dayLabel = oldest === 1 ? "day" : "days";
            const itemLabel = count === 1 ? "item" : "items";
            return `${count} ${itemLabel} have been on the list for ${oldest} ${dayLabel}. Consider checking them off or moving them into inventory.`;
          },
          formatShortfall(short) {
            const amount =
              this.formatAmount(short.need_g, "g") ||
              this.formatAmount(short.need_ml, "ml") ||
              this.formatAmount(short.need_count, "count") ||
              "as needed";
            const reason = short.reason ? short.reason.replace(/_/g, " ") : "required";
            return `${short.name || "Ingredient"} ‚Äî ${amount} (${reason})`;
          },
          formatStep(step) {
            if (!step) {
              return "Follow your cooking instincts and season to taste.";
            }
            return step.replace(/^[\\d\\.\\)\\s]+/, "").trim();
          },
          describeCandidate(candidate) {
            const parts = [];
            if (candidate.estimated_time_min != null) {
              parts.push(`${candidate.estimated_time_min} min prep`);
            }
            if (candidate.servings != null) {
              parts.push(`Base serves ${candidate.servings}`);
            }
            parts.push(`Scaled to ${this.targetServingsLabel(candidate).toLowerCase()}`);
            return parts.join(" ‚Ä¢ ");
          },
          candidateMealKey(candidate) {
            const planDate = this.planner.plan?.date || this.planner.form.date;
            const title = candidate.title || "Remy Dinner";
            return `${planDate || "pending"}::${title}`;
          },
          isCandidateSaving(candidate) {
            return this.planner.mealSaveState[this.candidateMealKey(candidate)] === "saving";
          },
          setCandidateSaveState(candidate, state) {
            const key = this.candidateMealKey(candidate);
            this.planner.mealSaveState = {
              ...this.planner.mealSaveState,
              [key]: state,
            };
          },
          async saveCandidateToMeals(candidate) {
            const planDate = this.planner.plan?.date || this.planner.form.date;
            if (!planDate) {
              this.planner.status = "Please select a date before saving meals.";
              this.planner.statusColor = "text-red-300";
              return;
            }
            const title = candidate.title || "Remy Dinner";
            this.setCandidateSaveState(candidate, "saving");
            this.planner.status = `Saving ${title} to Meals‚Ä¶`;
            this.planner.statusColor = "text-primary-300";
            try {
              const response = await fetch("/meals", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({
                  date: planDate,
                  title,
                  rating: null,
                  notes: null,
                }),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              await this.loadMeals();
              this.planner.status = `${title} saved to Meals.`;
              this.planner.statusColor = "text-green-300";
            } catch (error) {
              this.planner.status = `Unable to save meal: ${error.message}`;
              this.planner.statusColor = "text-red-300";
            } finally {
              this.setCandidateSaveState(candidate, "idle");
            }
          },
          shoppingShortfallKey(candidate, short) {
            const mealKey = this.candidateMealKey(candidate);
            return `${mealKey}::${short.name}::${short.reason || "unknown"}`;
          },
          isShoppingItemAdding(candidate, short) {
            return (
              this.planner.shoppingAddState[this.shoppingShortfallKey(candidate, short)] === "saving"
            );
          },
          setShoppingAddState(candidate, short, state) {
            const key = this.shoppingShortfallKey(candidate, short);
            this.planner.shoppingAddState = {
              ...this.planner.shoppingAddState,
              [key]: state,
            };
          },
          async addShortfallToShoppingList(candidate, short, options = {}) {
            const { silent = false, notePrefix = "Plan shortfall" } = options;
            const name = short.name || "Missing ingredient";
            if (!silent) {
              this.setShoppingAddState(candidate, short, "saving");
              this.planner.status = `Adding ${name} to the shopping list‚Ä¶`;
              this.planner.statusColor = "text-primary-300";
            }
            try {
              const payload = {
                name,
                quantity: short.need_g || short.need_ml || short.need_count || null,
                unit: short.need_g ? "g" : short.need_ml ? "ml" : short.need_count ? "count" : null,
                notes: `${notePrefix}: ${candidate.title || "Remy dinner"}`,
              };
              const response = await fetch("/shopping-list", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(this.formatApiError(detail, response.status));
              }
              if (!silent) {
                await this.loadShoppingList();
                this.planner.status = `${name} added to the shopping list.`;
                this.planner.statusColor = "text-green-300";
              }
              return true;
            } catch (error) {
              if (!silent) {
                this.planner.status = `Unable to add ${name}: ${error.message}`;
                this.planner.statusColor = "text-red-300";
              } else {
                console.warn("Auto-add shopping list failed", name, error);
              }
              return false;
            } finally {
              if (!silent) {
                this.setShoppingAddState(candidate, short, "idle");
              }
            }
          },
          isShoppingItemBusy(itemId) {
            return Boolean(this.shopping.pending[itemId]);
          },
          setShoppingPending(itemId, busy) {
            const next = { ...this.shopping.pending };
            if (busy) {
              next[itemId] = true;
            } else {
              delete next[itemId];
            }
            this.shopping.pending = next;
          },
          async refreshAll() {
            await Promise.all([
              this.loadPreferences(),
              this.loadInventory(),
              this.loadShoppingList(),
              this.loadReceipts(),
              this.loadMeals(),
              this.loadSuggestions(),
            ]);
            try {
              await this.assemblePlanningContext();
            } catch (error) {
              console.warn("Failed to assemble context during refresh", error);
            }
          },
          async assemblePlanningContext() {
            this.planner.contextLoading = true;
            this.planner.contextStatus = "Assembling context‚Ä¶";
            this.planner.contextStatusColor = "text-primary-300";
            try {
              const params = new URLSearchParams();
              const dateValue = this.planner.form.date || new Date().toISOString().slice(0, 10);
              params.set("date", dateValue);
              const attendeesValue = Number(this.planner.form.attendees);
              if (Number.isFinite(attendeesValue) && attendeesValue > 0) {
                params.set("attendees", attendeesValue.toString());
              }
              const windowValue = (this.planner.form.time_window || "").trim();
              if (windowValue) {
                params.set("time_window", windowValue);
              }
              const dietValue = (this.planner.form.diet_override || "").trim();
              if (dietValue) {
                params.set("diet_override", dietValue);
              }
              const allergens = this.parseCsvList(this.planner.form.allergens_text);
              allergens.forEach((allergen) => {
                params.append("allergens", allergen);
              });
              const maxTimeValue = Number(this.planner.form.max_time_min);
              if (Number.isFinite(maxTimeValue) && maxTimeValue > 0) {
                params.set("max_time_min", maxTimeValue.toString());
              }
              const cuisines = this.parseCsvList(this.planner.form.cuisines_text);
              cuisines.forEach((cuisine) => {
                params.append("preferred_cuisines", cuisine);
              });
              params.set("recipe_search", this.planner.form.search_enabled ? "true" : "false");
              const searchKeywords = this.parseCsvList(this.planner.form.search_keywords_text);
              searchKeywords.forEach((keyword) => {
                params.append("search_keywords", keyword);
              });
              const response = await fetch(`/planning-context?${params.toString()}`, {
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.text();
                throw new Error(`Context request failed (${response.status}): ${detail || 'unknown error'}`);
              }
              const context = await response.json();
              this.planner.contextObject = context;
              this.planner.context = JSON.stringify(context, null, 2);
              const dietLabel = context?.prefs?.diet || "flex";
              const inventoryCount = context?.inventory?.length || 0;
              this.planner.contextStatus = `Context ready (diet: ${dietLabel}, ${inventoryCount} inventory items)`;
              this.planner.contextStatusColor = "text-green-300";
              const targetServings = attendeesValue > 0 ? attendeesValue : context?.constraints?.attendees || 2;
              this.planner.servingTarget = Math.max(1, Math.round((targetServings || 2) * 2) / 2);
              if (context?.planner_options) {
                this.planner.form.search_enabled = Boolean(context.planner_options.recipe_search_enabled);
                const keywords = Array.isArray(context.planner_options.recipe_search_keywords)
                  ? context.planner_options.recipe_search_keywords.filter(Boolean)
                  : [];
                this.planner.form.search_keywords_text = keywords.join(", ");
              }
              return context;
            } catch (error) {
              this.planner.contextStatus = `Context error: ${error.message}`;
              this.planner.contextStatusColor = "text-red-300";
              throw error;
            } finally {
              this.planner.contextLoading = false;
            }
          },
          async generatePlan() {
            this.planner.loading = true;
            this.planner.status = "Generating plan‚Ä¶";
            this.planner.statusColor = "text-primary-300";
            try {
              const context = await this.assemblePlanningContext();
              const response = await fetch("/plan", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(context),
              });
              if (!response.ok) {
                const detail = await response.text();
                throw new Error(`Planner request failed (${response.status}): ${detail}`);
              }
              this.planner.plan = await response.json();
              this.initializeServingTarget(this.planner.plan, context);
              this.planner.showRaw = false;
              this.planner.status = "Plan generated successfully.";
              this.planner.statusColor = "text-green-300";
            } catch (error) {
              this.planner.plan = null;
              this.planner.status = `Error: ${error.message}`;
              this.planner.statusColor = "text-red-300";
            } finally {
              this.planner.loading = false;
            }
          },
          async loadPreferences() {
            this.preferences.loading = true;
            this.preferences.status = "Loading preferences‚Ä¶";
            this.preferences.statusColor = "text-slate-300";
            try {
              const response = await fetch("/preferences");
              if (!response.ok) {
                throw new Error(`Failed to load preferences (${response.status})`);
              }
              const data = await response.json();
              this.preferences.view = data;
              this.preferences.form = {
                diet: data.diet || "",
                max_time_min: data.max_time_min ?? null,
                allergensText: Array.isArray(data.allergens)
                  ? data.allergens.join(", ")
                  : "",
              };
              if (!this.planner.overridesInitialized) {
                this.applySavedPreferenceOverrides();
              }
              this.preferences.status = "Preferences loaded.";
              this.preferences.statusColor = "text-slate-300";
            } catch (error) {
              this.preferences.status = `Error loading preferences: ${error.message}`;
              this.preferences.statusColor = "text-red-300";
            } finally {
              this.preferences.loading = false;
            }
          },
          async savePreferences() {
            this.preferences.loading = true;
            this.preferences.status = "Saving preferences‚Ä¶";
            this.preferences.statusColor = "text-primary-300";
            try {
              const payload = {
                diet: this.preferences.form.diet.trim() || null,
                max_time_min:
                  this.preferences.form.max_time_min !== null &&
                  this.preferences.form.max_time_min !== ""
                    ? Number(this.preferences.form.max_time_min)
                    : null,
                allergens: this.preferences.form.allergensText
                  .split(",")
                  .map((value) => value.trim())
                  .filter(Boolean),
              };
              const response = await fetch("/preferences", {
                method: "PUT",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(
                  detail?.detail ? JSON.stringify(detail.detail) : `Status ${response.status}`
                );
              }
              this.preferences.status = "Preferences saved.";
              this.preferences.statusColor = "text-green-300";
              await this.loadPreferences();
            } catch (error) {
              this.preferences.status = `Error saving preferences: ${error.message}`;
              this.preferences.statusColor = "text-red-300";
            } finally {
              this.preferences.loading = false;
            }
          },
          formatApiError(detail, statusCode) {
            if (!detail) {
              return `Status ${statusCode}`;
            }
            if (typeof detail === "string") {
              return detail;
            }
            if (typeof detail.detail === "string") {
              return detail.detail;
            }
            try {
              return JSON.stringify(detail);
            } catch (error) {
              return `Status ${statusCode}`;
            }
          },
          async loadShoppingList() {
            this.shopping.loading = true;
            this.shopping.status = "Loading shopping list‚Ä¶";
            this.shopping.statusColor = "text-slate-300";
            try {
              const response = await fetch("/shopping-list");
              if (!response.ok) {
                throw new Error(`Failed to load shopping list (${response.status})`);
              }
              const data = await response.json();
              this.shopping.items = Array.isArray(data) ? data : [];
              this.shopping.reminder = this.computeShoppingReminder(this.shopping.items);
              const count = this.shopping.items.length;
              this.shopping.status =
                count === 0 ? "No shopping items yet. Add what you need for tonight." : `Tracking ${count} shopping item(s).`;
              this.shopping.statusColor = "text-slate-300";
            } catch (error) {
              this.shopping.status = `Error loading shopping list: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.shopping.loading = false;
              this.shopping.pending = {};
            }
          },
          async createShoppingItem() {
            const form = this.shopping.form;
            const name = (form.name || "").trim();
            if (!name) {
              this.shopping.status = "Item name is required.";
              this.shopping.statusColor = "text-red-300";
              return;
            }
            let quantity = null;
            if (form.quantity !== "" && form.quantity !== null && form.quantity !== undefined) {
              const parsed = Number(form.quantity);
              if (!Number.isFinite(parsed) || parsed <= 0) {
                this.shopping.status = "Quantity must be a positive number.";
                this.shopping.statusColor = "text-red-300";
                return;
              }
              quantity = parsed;
            }
            const payload = { name };
            if (quantity !== null) {
              payload.quantity = quantity;
            }
            const unit = (form.unit || "").trim();
            if (unit) {
              payload.unit = unit;
            }
            const notes = (form.notes || "").trim();
            if (notes) {
              payload.notes = notes;
            }
            this.shopping.loading = true;
            try {
              const response = await fetch("/shopping-list", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(this.formatApiError(detail, response.status));
              }
              this.shopping.status = "Shopping item added.";
              this.shopping.statusColor = "text-green-300";
              this.shopping.form = { name: "", quantity: "", unit: unit || "ea", notes: "" };
              await this.loadShoppingList();
            } catch (error) {
              this.shopping.status = `Error saving item: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.shopping.loading = false;
            }
          },
          async toggleShoppingItem(item) {
            this.setShoppingPending(item.id, true);
            try {
              const response = await fetch(`/shopping-list/${item.id}`, {
                method: "PUT",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ is_checked: !item.is_checked }),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(this.formatApiError(detail, response.status));
              }
              await this.loadShoppingList();
            } catch (error) {
              this.shopping.status = `Error updating ${item.name}: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.setShoppingPending(item.id, false);
            }
          },
          async deleteShoppingItem(item) {
            if (!window.confirm(`Remove ${item.name} from the list?`)) {
              return;
            }
            this.setShoppingPending(item.id, true);
            try {
              const response = await fetch(`/shopping-list/${item.id}`, {
                method: "DELETE",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(this.formatApiError(detail, response.status));
              }
              this.shopping.status = `${item.name} removed from the list.`;
              this.shopping.statusColor = "text-green-300";
              await this.loadShoppingList();
            } catch (error) {
              this.shopping.status = `Error deleting ${item.name}: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.setShoppingPending(item.id, false);
            }
          },
          async resetShoppingList() {
            if (!this.shopping.items.length) {
              this.shopping.status = "Shopping list is already empty.";
              this.shopping.statusColor = "text-slate-300";
              return;
            }
            if (!window.confirm("Reset the entire shopping list?")) {
              return;
            }
            this.shopping.loading = true;
            try {
              const response = await fetch("/shopping-list/reset", {
                method: "POST",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(this.formatApiError(detail, response.status));
              }
              this.shopping.status = "Shopping list cleared.";
              this.shopping.statusColor = "text-green-300";
              await this.loadShoppingList();
            } catch (error) {
              this.shopping.status = `Error resetting list: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.shopping.loading = false;
            }
          },
          async addShoppingItemToInventory(item) {
            let quantity = item.quantity;
            if (quantity == null) {
              const promptValue = window.prompt(
                `How many ${item.name} did you pick up?`,
                "1"
              );
              if (promptValue === null) {
                this.shopping.status = "Add to inventory canceled.";
                this.shopping.statusColor = "text-slate-300";
                return;
              }
              const parsed = Number(promptValue);
              if (!Number.isFinite(parsed) || parsed <= 0) {
                this.shopping.status = "Quantity must be greater than zero.";
                this.shopping.statusColor = "text-red-300";
                return;
              }
              quantity = parsed;
            }
            let unit = item.unit;
            if (!unit) {
              const unitValue = window.prompt("Unit (e.g., g, ml, ea)", "ea");
              if (unitValue === null) {
                this.shopping.status = "Add to inventory canceled.";
                this.shopping.statusColor = "text-slate-300";
                return;
              }
              unit = unitValue.trim() || "ea";
            }
            const payload = {
              name: item.name,
              quantity,
              unit,
            };
            if (item.notes) {
              payload.notes = item.notes;
            }
            this.setShoppingPending(item.id, true);
            this.shopping.status = `Adding ${item.name} to inventory‚Ä¶`;
            this.shopping.statusColor = "text-primary-300";
            try {
              const response = await fetch(`/shopping-list/${item.id}/add-to-inventory`, {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              await Promise.all([this.loadShoppingList(), this.loadInventory()]);
              this.shopping.status = `${item.name} added to inventory.`;
              this.shopping.statusColor = "text-green-300";
            } catch (error) {
              this.shopping.status = `Error adding to inventory: ${error.message}`;
              this.shopping.statusColor = "text-red-300";
            } finally {
              this.setShoppingPending(item.id, false);
            }
          },
          async loadInventory() {
            this.inventory.loading = true;
            this.inventory.status = "Loading inventory‚Ä¶";
            this.inventory.statusColor = "text-slate-300";
            try {
              const response = await fetch("/inventory");
              if (!response.ok) {
                throw new Error(`Failed to load inventory (${response.status})`);
              }
              const data = await response.json();
              this.inventory.items = (Array.isArray(data) ? data : []).map((item) => ({
                ...item,
                editQuantity:
                  item.qty ?? item.quantity ?? item.quantity ?? 0,
              }));
              this.inventory.status = `Loaded ${this.inventory.items.length} item(s).`;
              this.inventory.statusColor = "text-slate-300";
            } catch (error) {
              this.inventory.status = `Error loading inventory: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            } finally {
              this.inventory.loading = false;
            }
          },
          async createInventoryItem() {
            const form = this.inventory.form;
            if (!form.name.trim()) {
              this.inventory.status = "Name is required.";
              this.inventory.statusColor = "text-red-300";
              return;
            }
            const quantity = Number(form.quantity);
            if (!Number.isFinite(quantity) || quantity <= 0) {
              this.inventory.status = "Quantity must be greater than zero.";
              this.inventory.statusColor = "text-red-300";
              return;
            }
            this.inventory.loading = true;
            try {
              const payload = {
                name: form.name.trim(),
                quantity,
                unit: form.unit.trim() || "g",
                best_before: form.best_before || null,
                notes: form.notes.trim() || null,
              };
              const response = await fetch("/inventory", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.inventory.status = "Item added to inventory.";
              this.inventory.statusColor = "text-green-300";
              this.inventory.form = { name: "", quantity: "", unit: "g", best_before: "", notes: "" };
              await this.loadInventory();
            } catch (error) {
              this.inventory.status = `Error saving item: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            } finally {
              this.inventory.loading = false;
            }
          },
          async updateInventoryItem(item) {
            const quantity = Number(item.editQuantity);
            if (!Number.isFinite(quantity) || quantity <= 0) {
              this.inventory.status = "Quantity must be a positive number.";
              this.inventory.statusColor = "text-red-300";
              return;
            }
            try {
              const response = await fetch(`/inventory/${item.id}`, {
                method: "PUT",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ quantity }),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.inventory.status = "Inventory item updated.";
              this.inventory.statusColor = "text-green-300";
              await this.loadInventory();
            } catch (error) {
              this.inventory.status = `Error updating item: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            }
          },
          async deleteInventoryItem(item) {
            if (!window.confirm(`Delete ${item.name}?`)) {
              return;
            }
            try {
              const response = await fetch(`/inventory/${item.id}`, {
                method: "DELETE",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.inventory.status = "Inventory item deleted.";
              this.inventory.statusColor = "text-green-300";
              await this.loadInventory();
            } catch (error) {
              this.inventory.status = `Error deleting item: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            }
          },
          async loadReceipts() {
            this.receipts.loading = true;
            this.receipts.status = "Loading receipts‚Ä¶";
            this.receipts.statusColor = "text-slate-300";
            this.receipts.selections = {};
            this.receipts.submitting = {};
            try {
              const response = await fetch("/receipts");
              if (!response.ok) {
                throw new Error(`Failed to load receipts (${response.status})`);
              }
              const data = await response.json();
              const items = Array.isArray(data) ? data : [];
              const enriched = await Promise.all(
                items.map(async (entry) => {
                  const ocr = await this.fetchReceiptOcr(entry.id);
                  return { ...entry, ocr };
                })
              );
              this.receipts.items = enriched;
              for (const entry of enriched) {
                this.receipts.selections[entry.id] = this.initializeReceiptSelection(entry);
              }
              this.receipts.status = `Loaded ${this.receipts.items.length} receipt(s).`;
              this.receipts.statusColor = "text-slate-300";
            } catch (error) {
              this.receipts.status = `Error loading receipts: ${error.message}`;
              this.receipts.statusColor = "text-red-300";
            } finally {
              this.receipts.loading = false;
            }
          },
          parsedItems(receipt) {
            return (
              receipt?.ocr?.metadata?.parsed?.items &&
              Array.isArray(receipt.ocr.metadata.parsed.items)
                ? receipt.ocr.metadata.parsed.items
                : []
            );
          },
          ingestedItems(receipt) {
            const metadata = receipt?.ocr?.metadata;
            if (!metadata?.ingested || !Array.isArray(metadata.ingested)) {
              return [];
            }
            return metadata.ingested;
          },
          initializeReceiptSelection(receipt) {
            const parsed = this.parsedItems(receipt);
            return parsed.map((item) => ({
              raw: item,
              selected: (item.confidence ?? 0) >= 0.5,
              name: item.name || "",
              quantity: item.quantity != null ? Number(item.quantity) : null,
              unit: item.unit || "",
              inventory_match_id:
                item.inventory_match_id != null ? Number(item.inventory_match_id) : null,
              inventory_match_name: item.inventory_match_name || null,
              notes: "",
            }));
          },
          receiptSelection(receiptId) {
            return this.receipts.selections[receiptId] || [];
          },
          async fetchReceiptOcr(receiptId) {
            try {
              const response = await fetch(`/receipts/${receiptId}/ocr`);
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              return await response.json();
            } catch (error) {
              return {
                receipt_id: receiptId,
                status: "failed",
                error_message: error.message,
                metadata: { reason: "status-unavailable" },
              };
            }
          },
          handleReceiptFile(event) {
            const [file] = event.target.files || [];
            this.receipts.upload.file = file || null;
          },
          isReceiptProcessing(receiptId) {
            return Boolean(this.receipts.processing[receiptId]);
          },
          isReceiptExpanded(receiptId) {
            return Boolean(this.receipts.expanded[receiptId]);
          },
          toggleReceiptExpansion(receiptId) {
            this.receipts.expanded[receiptId] = !this.isReceiptExpanded(receiptId);
          },
          updateReceiptOcr(receiptId, ocr) {
            this.receipts.items = this.receipts.items.map((entry) =>
              entry.id === receiptId ? { ...entry, ocr } : entry
            );
            const updated = this.receipts.items.find((entry) => entry.id === receiptId);
            if (updated) {
              this.receipts.selections[receiptId] = this.initializeReceiptSelection(updated);
            }
          },
          async uploadReceipt() {
            if (!this.receipts.upload.file) {
              this.receipts.status = "Select a receipt file first.";
              this.receipts.statusColor = "text-red-300";
              return;
            }
            this.receipts.loading = true;
            this.receipts.status = "Uploading receipt‚Ä¶";
            this.receipts.statusColor = "text-primary-300";
            try {
              const formData = new FormData();
              formData.append("file", this.receipts.upload.file);
              if (this.receipts.upload.notes.trim()) {
                formData.append("notes", this.receipts.upload.notes.trim());
              }
              const response = await fetch("/receipts", {
                method: "POST",
                headers: this.authHeaders(),
                body: formData,
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.receipts.status = "Receipt uploaded.";
              this.receipts.statusColor = "text-green-300";
              this.receipts.upload = { file: null, notes: "" };
              const form = document.getElementById("receipt-form");
              if (form) {
                form.reset();
              }
              await this.loadReceipts();
            } catch (error) {
              this.receipts.status = `Error uploading receipt: ${error.message}`;
              this.receipts.statusColor = "text-red-300";
            } finally {
              this.receipts.loading = false;
            }
          },
          async loadSuggestions() {
            this.inventory.suggestionStatus = "Loading suggestions‚Ä¶";
            this.inventory.suggestionStatusColor = "text-slate-300";
            try {
              const response = await fetch("/inventory/suggestions");
              if (!response.ok) {
                throw new Error(`Failed to load suggestions (${response.status})`);
              }
              const data = await response.json();
              this.inventory.suggestions = Array.isArray(data) ? data : [];
              this.inventory.suggestionStatus = `${this.inventory.suggestions.length} suggestion(s) awaiting review.`;
              this.inventory.suggestionStatusColor =
                this.inventory.suggestions.length > 0 ? "text-yellow-300" : "text-slate-300";
            } catch (error) {
              this.inventory.suggestionStatus = `Error loading suggestions: ${error.message}`;
              this.inventory.suggestionStatusColor = "text-red-300";
            }
          },
          async loadMeals() {
            this.meals.loading = true;
            this.meals.status = "Loading meals‚Ä¶";
            this.meals.statusColor = "text-slate-300";
            try {
              const response = await fetch("/meals");
              if (!response.ok) {
                throw new Error(`Failed to load meals (${response.status})`);
              }
              const data = await response.json();
              this.meals.items = Array.isArray(data)
                ? data.map((meal) => ({ ...meal, editRating: meal.rating || "", editNotes: meal.notes || "" }))
                : [];
              this.meals.status = `${this.meals.items.length} recorded meal(s).`;
              this.meals.statusColor = "text-slate-300";
            } catch (error) {
              this.meals.status = `Error loading meals: ${error.message}`;
              this.meals.statusColor = "text-red-300";
            } finally {
              this.meals.loading = false;
            }
          },
          async saveMeal(meal) {
            this.meals.status = "Saving meal‚Ä¶";
            this.meals.statusColor = "text-primary-300";
            try {
              const payload = {
                date: meal.date,
                title: meal.title,
                rating: meal.editRating !== "" ? Number(meal.editRating) : null,
                notes: meal.editNotes?.trim() ? meal.editNotes.trim() : null,
              };
              const response = await fetch("/meals", {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(payload),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.meals.status = "Meal saved.";
              this.meals.statusColor = "text-green-300";
              await this.loadMeals();
            } catch (error) {
              this.meals.status = `Error saving meal: ${error.message}`;
              this.meals.statusColor = "text-red-300";
            }
          },
          async addMeal() {
            if (!this.meals.form.title.trim()) {
              this.meals.status = "Enter a meal title.";
              this.meals.statusColor = "text-red-300";
              return;
            }
            await this.saveMeal({
              date: this.meals.form.date,
              title: this.meals.form.title.trim(),
              editRating: this.meals.form.rating !== "" ? Number(this.meals.form.rating) : null,
              editNotes: this.meals.form.notes,
            });
            this.meals.form = {
              date: new Date().toISOString().slice(0, 10),
              title: "",
              rating: "",
              notes: "",
            };
          },
          async deleteMeal(meal) {
            if (!window.confirm(`Delete meal ${meal.title}?`)) {
              return;
            }
            try {
              const response = await fetch(`/meals?date=${meal.date}&title=${encodeURIComponent(meal.title)}`, {
                method: "DELETE",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.meals.status = "Meal deleted.";
              this.meals.statusColor = "text-green-300";
              await this.loadMeals();
            } catch (error) {
              this.meals.status = `Error deleting meal: ${error.message}`;
              this.meals.statusColor = "text-red-300";
            }
          },
          async approveSuggestion(suggestion, overrides = {}) {
            try {
              const response = await fetch(`/inventory/suggestions/${suggestion.id}/approve`, {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify(overrides),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.inventory.status = `Approved suggestion ${suggestion.name}.`;
              this.inventory.statusColor = "text-green-300";
              await Promise.all([this.loadInventory(), this.loadSuggestions()]);
            } catch (error) {
              this.inventory.status = `Error approving suggestion: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            }
          },
          async dismissSuggestion(suggestionId) {
            try {
              const response = await fetch(`/inventory/suggestions/${suggestionId}`, {
                method: "DELETE",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.inventory.status = "Suggestion dismissed.";
              this.inventory.statusColor = "text-green-300";
              await this.loadSuggestions();
            } catch (error) {
              this.inventory.status = `Error dismissing suggestion: ${error.message}`;
              this.inventory.statusColor = "text-red-300";
            }
          },
          async runReceiptOcr(receipt) {
            this.receipts.processing = { ...this.receipts.processing, [receipt.id]: true };
            this.receipts.status = `Running OCR for ${receipt.filename}‚Ä¶`;
            this.receipts.statusColor = "text-primary-300";
            try {
              const response = await fetch(`/receipts/${receipt.id}/ocr`, {
                method: "POST",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              const ocr = await response.json();
              this.updateReceiptOcr(receipt.id, ocr);
              const ingestedCount = ocr?.metadata?.ingested?.length || 0;
              const suggestionCount = ocr?.metadata?.suggestions?.length || 0;
              await Promise.all([this.loadInventory(), this.loadSuggestions()]);
              if (ingestedCount > 0) {
                this.receipts.status = `OCR complete. Added ${ingestedCount} item(s) to inventory.`;
                this.receipts.statusColor = "text-green-300";
              } else if (suggestionCount > 0) {
                this.receipts.status =
                  `OCR complete. ${suggestionCount} item(s) need review in Pending Suggestions.`;
                this.receipts.statusColor = "text-yellow-300";
              } else {
                this.receipts.status = "OCR processing complete.";
                this.receipts.statusColor = "text-green-300";
              }
            } catch (error) {
              this.receipts.status = `Error running OCR: ${error.message}`;
              this.receipts.statusColor = "text-red-300";
            } finally {
              const copy = { ...this.receipts.processing };
              delete copy[receipt.id];
              this.receipts.processing = copy;
            }
          },
          async approveReceiptItems(receipt) {
            const selection = this.receiptSelection(receipt.id);
            const items = selection
              .filter((item) => item.selected)
              .map((item) => ({
                name: item.name.trim(),
                quantity:
                  item.quantity != null && item.quantity !== ""
                    ? Number(item.quantity)
                    : null,
                unit: item.unit ? item.unit.trim() : null,
                inventory_match_id: item.inventory_match_id || null,
                notes: item.notes?.trim() ? item.notes.trim() : null,
              }));

            if (!items.length) {
              this.receipts.status = "Select at least one item to ingest.";
              this.receipts.statusColor = "text-red-300";
              return;
            }

            this.receipts.submitting = { ...this.receipts.submitting, [receipt.id]: true };
            this.receipts.status = `Ingesting ${items.length} item(s)‚Ä¶`;
            this.receipts.statusColor = "text-primary-300";
            try {
              const response = await fetch(`/receipts/${receipt.id}/ingest`, {
                method: "POST",
                headers: this.authHeaders({ "Content-Type": "application/json" }),
                body: JSON.stringify({ items }),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              await Promise.all([this.loadInventory(), this.loadReceipts()]);
              this.receipts.status = "Receipt items ingested into inventory.";
              this.receipts.statusColor = "text-green-300";
            } catch (error) {
              this.receipts.status = `Error ingesting items: ${error.message}`;
              this.receipts.statusColor = "text-red-300";
            } finally {
              const copy = { ...this.receipts.submitting };
              delete copy[receipt.id];
              this.receipts.submitting = copy;
            }
          },
          async deleteReceipt(receipt) {
            if (!window.confirm(`Delete receipt ${receipt.filename}?`)) {
              return;
            }
            try {
              const response = await fetch(`/receipts/${receipt.id}`, {
                method: "DELETE",
                headers: this.authHeaders(),
              });
              if (!response.ok) {
                const detail = await response.json().catch(() => ({}));
                throw new Error(detail?.detail || `Status ${response.status}`);
              }
              this.receipts.status = "Receipt deleted.";
              this.receipts.statusColor = "text-green-300";
              const expanded = { ...this.receipts.expanded };
              delete expanded[receipt.id];
              this.receipts.expanded = expanded;
              const processing = { ...this.receipts.processing };
              delete processing[receipt.id];
              this.receipts.processing = processing;
              const selections = { ...this.receipts.selections };
              delete selections[receipt.id];
              this.receipts.selections = selections;
              const submitting = { ...this.receipts.submitting };
              delete submitting[receipt.id];
              this.receipts.submitting = submitting;
              await this.loadReceipts();
            } catch (error) {
              this.receipts.status = `Error deleting receipt: ${error.message}`;
              this.receipts.statusColor = "text-red-300";
            }
          },
        },
        mounted() {
          this.refreshAll();
        },
      });

      app.mount("#app");
    </script>
    <style>
      .hide-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .hide-scrollbar {
        scrollbar-width: none;
      }
      .i-lucide-key::before {
        content: "üîê";
      }
      .i-lucide-refresh-cw::before {
        content: "üîÑ";
      }
      .i-lucide-wand-2::before {
        content: "ü™Ñ";
      }
      .i-lucide-save::before {
        content: "üíæ";
      }
      .i-lucide-plus::before {
        content: "‚ûï";
      }
      .i-lucide-trash::before {
        content: "üóëÔ∏è";
      }
      .i-lucide-upload::before {
        content: "‚¨ÜÔ∏è";
      }
      .i-lucide-download::before {
        content: "‚¨áÔ∏è";
      }
      .i-lucide-scan-text::before {
        content: "üìù";
      }
      .i-lucide-eye::before {
        content: "üëÅÔ∏è";
      }
      .i-lucide-eye-off::before {
        content: "üôà";
      }
      .i-lucide-check::before {
        content: "‚úÖ";
      }
    </style>
  </body>
</html>
